name: PR Tests

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # First, discover all PR test configs
  discover-configs:
    runs-on: [self-hosted, entropy]
    outputs:
      configs: ${{ steps.find-configs.outputs.configs }}
    steps:
      - uses: actions/checkout@v4

      - name: Find PR test configs
        id: find-configs
        run: |
          # Find all yaml files in configs/pr_tests/ and output as JSON array
          echo "Searching for configs in configs/pr_tests/..."
          ls -la configs/pr_tests/ || echo "Directory not found or empty"

          configs=$(ls configs/pr_tests/*.yaml 2>/dev/null | xargs -I {} basename {} .yaml | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "configs=$configs" >> $GITHUB_OUTPUT

          echo "=== Found PR test configs ==="
          echo "$configs" | jq -r '.[]'
          echo "Total: $(echo "$configs" | jq 'length') config(s)"

  # Run each config as a separate job
  run-pr-test:
    needs: discover-configs
    runs-on: [self-hosted, entropy]
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.discover-configs.outputs.configs) }}
    steps:
      - uses: actions/checkout@v4

      - name: Run PR test - ${{ matrix.config }}
        run: |
          echo "=== Starting PR test for config: ${{ matrix.config }} ==="
          echo "Current directory: $(pwd)"
          chmod +x .github/scripts/run_remote_pr_check.sh
          export PR_TEST_CONFIG_NAME="${{ matrix.config }}"
          echo "Submitting SLURM job..."

          # Submit job and capture the job ID
          job_output=$(sbatch --wait --job-name="pr_test_${{ matrix.config }}" --output="slurm-%j.out" --export=ALL .github/scripts/run_remote_pr_check.sh)
          exit_code=$?
          job_id=$(echo "$job_output" | grep -oP 'Submitted batch job \K\d+')

          echo "$job_output"
          echo "Job ID: $job_id"
          echo "SLURM job completed with exit code: $exit_code"

          # Try to display the output immediately
          if [ -f "slurm-${job_id}.out" ]; then
            echo "=== SLURM Output (slurm-${job_id}.out) ==="
            cat "slurm-${job_id}.out"
          else
            echo "Warning: SLURM output file slurm-${job_id}.out not found in $(pwd)"
            echo "Looking for any slurm output files..."
            ls -la slurm-*.out 2>/dev/null || echo "No slurm output files found"
          fi

          exit $exit_code

      - name: Display SLURM output
        if: always()
        run: |
          latest_out=$(ls -t slurm-*.out 2>/dev/null | head -1)
          if [ -n "$latest_out" ]; then
            echo "=== SLURM Output for ${{ matrix.config }} ==="
            cat "$latest_out"
          fi
